---
title: "Pesticide Labels Now Report"
subtitle: Draft
date: "`r Sys.Date()`"
output:
  md_document: default
  word_document:
    toc: yes
    toc_depth: '4'
  html_document:
    code_folding: hide
    self_contained: yes
    toc: no
    toc_depth: 4
    toc_float: yes
  pdf_document:
    latex_engine: xelatex
    toc: yes
    toc_depth: 4
  bookdown::md_document:
    toc: yes
editor_options:
  chunk_output_type: console
---

```{r packages, warning=F, message=F, echo=F, results=F}

r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"
options(repos = r)
if(!require(pacman)) {install.packages("pacman", repos = "http://cran.us.r-project.org")}
pacman::p_load(tidyverse, utils, lubridate, readxl, vcd, kableExtra, table1, here, maps, sf, ggmap, sp, ggthemes, ggspatial, urbnmapr, breakDown, dplyr, expm, devtools, data.table, ggplot2, car, viridis, ggExtra, tidyr, tigris, frequency)

install.packages("bookdown")
install.packages("summarytools")
devtools::install_github("yutannihilation/ggsflabel")
devtools::install_github("UrbanInstitute/urbnmapr")

```


```{r setup, include=F, results='asis'}
library(summarytools)

st_options(plain.ascii = F, # Always use this option in Rmd documents
style        = "rmarkdown", # Always use this option in Rmd documents
footnote     = NA,          # Makes html-rendered results more concise
subtitle.emphasis = F)  # Improves layout with some rmarkdown themes

```


```{r upload-clean-data, warning=F, message=F, echo=F, results=F}

temp <- list.files(path='Outputs', pattern="*.csv", full.names = T)

list2env(lapply(setNames(temp, make.names(gsub("*.csv$", "", temp))), read.csv), envir = .GlobalEnv)

colnames(Outputs.evStart.1)[1] <- "aid"
colnames(Outputs.evStart.1)[2] <- "evDesc1"
colnames(Outputs.evStart.1)[3] <- "evDesc2"
colnames(Outputs.evStart.1)[4] <- "evDesc3"
colnames(Outputs.evStart.1)[5] <- "evType"
colnames(Outputs.evStart.1)[6] <- "ts"

Outputs.evStart <- do.call(rbind, lapply(ls(pattern = "Outputs.evStart"), get))

rm(list = ls()[grep("^Outputs.evStart.", ls())])

#Filter out ignores

ignores <- read.csv("ignores.csv")

evDownload.01 <- filter(Outputs.evDownload.01,!(aid %in% ignores$aid))

evStart <- filter(Outputs.evStart,!(aid %in% ignores$aid))

evViewPage.01 <- filter(Outputs.evViewPage.01,!(aid %in% ignores$aid))

rm(Outputs.evDownload.01, Outputs.evStart, Outputs.evViewPage.01)

```

# How do user characteristics inform or explain their interaction with the '[Pesticides Labels Now!](https://deohs.washington.edu/pnash/LabelsNow)' application? 
## Authors: Aarti Tandon, Eddie Kasner, Kit Galvin, Pablo Palmández

<br>

## Table of Contents
-   [Introduction](#introduction)
-   [Executive Summary](#executive-summary)
-   [Objective](#objective)
-   [Features to Help Understand User Characteristics](#features-to-help-understand-user-characteristics)
-   [Data Subsets](#data-subsets)
-   [Descriptive Statistics](#descriptive-statistics)
    -   [evDownload.01](#evdownload.01)
    -   [evStart](#evstart)
    -   [evViewPage.01](#evviewpage.01)
-   [App Use By Location](#app-use-by-location)
    -   [Plot for US Sessions](#plot-for-us-sessions)
    -   [Plot for WA sessions with County Names](#plot-for-wa-sessions-with-county-names)
-   [App Use By Device](#app-use-by-device)
    -   [Devices Utilized to Access the Application](#devices-utilized-to-access-the-application)
-   [App Use By Language](#app-use-by-language)   
    -   [Frequency of Each Language Accessed on the Application](#frequency-of-each-language-accessed-on-the-application)
    -   [Frequency of Different Languages by Operating System](#frequency-of-different-languages-by-operating-system)
-   [App Use By Time](#app-use-by-time)       
    -   [Comparing User Sessions by ‘Day of the Month’, ‘Month’, and ‘Activity of the User’](#comparing-user-sessions-by-day-of-the-month-month-and-activity-of-the-user) 
    -   [Comparing User Sessions by ‘Hour of the Day’, ‘Day of the Month’, and ‘Activity of the User’](#comparing-user-sessions-by-hour-of-the-day-day-of-the-month-and-activity-of-the-user) 
    -   [Comparing User Sessions by ‘Month’, ‘Day of the Month’, and ‘Session Time (in minutes)’](#comparing-user-sessions-by-month-day-of-the-month-and-session-time-in-minutes)
    -   [Comparing User Sessions by ‘Hour of the Month’, ‘Day of the Month’, ‘Month’, and ‘Year’](#comparing-user-sessions-by-hour-of-the-month-day-of-the-month-month-and-year)  
-   [App Use By Activity](#app-use-by-activity)  
    -   [Frequency of Each Source Page Accessed on the Application](#frequency-of-each-source-page-accessed-on-the-application)
    -   [Activity in Each Label Section](#activity-in-each-label-section)
    -   [Frequency of Links Utilized](#frequency-of-links-utilized)     
    -   [Frequency of Different Links by Language](#frequency-of-different-links-by-language)     
-   [Average Session Duration](#average-session-duration)       
-   [Appendix](#appendix)   
<br>


# Introduction
<img src="myself.png" alt="drawing" width="400"/>

Hi! My name is Aarti Tandon and I am currently working as an Undergraduate Research Assistant here at the University of Washington. Through the [SURE-EH program](https://deohs.washington.edu/apply-sure-eh), I work with the [Pacific Northwest Agricultural Safety and Health Center](https://deohs.washington.edu/pnash/) under the mentorship of Dr. Eddie Kasner and Kit Galvin. This is my markdown file that I have been working on this past year where I have analyzed data from the '[Bilingual Health and Safety Messaging](https://deohs.washington.edu/pnash/LabelsNow)' application. My research is focused on reducing the gaps in fair and equal access for marginalized peoples by understanding our user audience and their preferences for app utility. While working on the app, I have been able to stand at the crossroads of technology and human health. Using the tools of statistics and data visualization, I have contributed to research translation and the improvement of  human health, environmental resilience, and social and economic equity.

# Executive Summary
The ‘[Pesticides Labels Now!](https://deohs.washington.edu/pnash/LabelsNow)’ mobile application strives to minimize agricultural worker and community exposure and illness from agricultural pesticides through improving access to pesticide labels and safety information in Spanish and English. Pesticide handlers, managers, and supervisors are able to gain access to this information, change behaviors accordingly, and transfer the safety information to others. We hypothesized that user characteristics such as language choice, mobile device type, and location would determine frequency of interactions with the application. This study investigates the application’s user audience and their preferences for app utility. Statistical analysis and graphing was conducted with R Studio (Version 2021.09.1) for users accessing the application over one year starting in August 2020. The raw data set consisted primarily of users from the State of Washington, containing 67,754 interactions and a total of 503 unique users. The results showed that user utilization is predominantly concentrated in central Washington, which is part of the Columbia Basin, and has very productive agricultural land. The overall frequency of each language accessed on the application was relatively comparable - with 59% in English and 41% in Spanish. The analysis further indicated the majority of users utilize the application through an iOS system. An estimated 74% of interactions were accessed through an iPhone device and 26% were accessed through an Android device. By understanding the effect of user characteristics in their interaction with the application, necessary adjustments can be made to the application to create a more user-friendly experience and contribute to improving access to pesticide labels and their safety information. 

# Objective
## To understand the '[Pesticide Labels Now](https://deohs.washington.edu/pnash/LabelsNow)' mobile application user audience and their preferences for app utility. 

# Features to Help Understand User Characteristics 
- Location 
- Device 
- Language 

# Data Subsets
A data dictionary and descriptive statistics were prepared based on the Pesticide Labels Now (PLN) [analysis plan](https://docs.google.com/document/d/1mUHPYdpWljCWroODGenUjYlyae2ZWwqN4MScBLXlr2U/edit). For a better representation of users, we ignored a list of random identifiers ('aid' in *ignores.csv*) associated with the project team members and generated descriptive statistics for three subsets:

- [evDownload.01](https://github.com/aartitandon/SURE-EH-Research-Project/blob/main/Appendix.md#evdownload01-subset)
- [evStart](https://github.com/aartitandon/SURE-EH-Research-Project/blob/main/Appendix.md#evstart-subset)
- [evViewPage.01](https://github.com/aartitandon/SURE-EH-Research-Project/blob/main/Appendix.md#evviewpage01-subset)

```{r evDownload-summary, eval=F, warning=F, message=F, echo=F, results='asis'}
library("frequency")

print(freq(evDownload.01$prodName, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

print(freq(evDownload.01$sourcePage, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

print(freq(evDownload.01$evType, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

#print(ctable(x = evDownload.01$evType, y = evDownload.01$sourcePage, prop = "r", style='rmarkdown'))

#print(freq(evDownload.01$aid, report.nas = F, totals = T, cumul = F, headings = T, order="freq"), method="render")

```

```{r evStart-summary, warning=F, message=F, echo=F, results='asis'}

#print(freq(evStart$evDesc1, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

#Tally device type using evDesc2 (all sessions)

evStart$evDesc2 <- as.character(evStart$evDesc2)

s <- strsplit(evStart$evDesc2, split = ",")

evStart$device_cat <- unlist(purrr::map(s, 1))

rm(s)

#Tally device types using evDesc2 (unique aid)

evStart.unique.device <- evStart %>%
  distinct_at(vars(aid), .keep_all = TRUE)

#print(freq(evStart.unique.device$device_cat, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

#print(freq(evStart$evDesc3, report.nas = F, totals = T, cumul = F, headings = T, order="freq"), method="render")

#print(freq(evStart$evType, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

#print(freq(evStart$aid, report.nas = F, totals = T, cumul = F, headings = T, order="freq"), method="render")

```


```{r evViewPage-summary, eval=F, warning=F, message=F, echo=F, results='asis'}

print(freq(evViewPage.01$evDesc1, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

print(freq(evViewPage.01$evDesc2, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

print(freq(evViewPage.01$evDesc3, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

print(freq(evViewPage.01$evType, report.nas = F, totals = T, cumul = F, headings = T, order="freq", style = 'rmarkdown'))

#print(freq(evViewPage.01$aid, report.nas = F, totals = T, cumul = F, headings = T, order="freq"), method="render")

```

# App Use By Location  
## Map for US Sessions in 2020-2021
```{r user-map-us, warning=F, message=F, echo=F, eval=T, out.width = "100%"}

#extract locations from evStart
## Remove parenthesizes from evDesc3 lat, long
evStart$evDesc3sub <- gsub("[()]", "", evStart$evDesc3)

## Separate lat/long
evStart <- evStart %>%
     filter(evDesc3sub != '0,0') %>%
     separate(evDesc3sub, into = c('lat','lon'), sep=",")

gps <- select(evStart, lat, lon)
gps <- na.omit(gps)
gps <- gps[gps$lat != NaN, ]
gps$lat <- as.numeric(gps$lat)
gps$lon <- as.numeric(gps$lon)

pln_sf <- gps %>% st_as_sf(coords = c("lon","lat"), crs=4326)
pln_sf_t <- st_transform(pln_sf, crs=2163)

library(urbnmapr)
states_sf <- get_urbn_map(map = "states", sf = T)

#Plot for US sessions

ggplot() + 
  geom_sf(data = pln_sf_t, color="red", size=1) + 
  geom_sf(data = states_sf, fill=NA, color="black", size=0.5, alpha=0) +
  coord_sf(datum = st_crs(2163)) +
  labs(fill = "", title="", caption="") + scale_x_continuous(limits = c(-3e+06, 3e+06)) +
    scale_y_continuous(limits = c(-3e+06, 1e+06)) + theme_nothing() 

```
<figcaption align = "center"><b>Figure 1 - App Utilization on United States Map </b></figcaption>
Predominant use is concentrated in Washington, however, there is scattered usage throughout the Eastern coast and California.


```{r user-map-wa, echo=F, warning=F, message=F, eval=T, out.width = "100%"}

#Plot for WA sessions

library(devtools)
library(urbnmapr)

counties_sf <- get_urbn_map(map = "counties", sf = T)

pln_sf_t <- st_transform(pln_sf, crs=2285)
counties_sf_t <- st_transform(counties_sf, crs=2285)

t <- counties_sf_t %>%
  filter(state_name == "Washington")

#ggplot() + 
  #geom_sf(data = pln_sf_t, color="red", size=1) + 
  #geom_sf(data = t, fill=NA, color="black", size=0.1, alpha=0) +
  #coord_sf(datum = st_crs(2285)) +
  #labs(fill = "", title="", caption="") + scale_x_continuous(limits = c(0.6e+06, 2.7e+06)) +
    #scale_y_continuous(limits = c(-0.7e+06, 0.8e+06)) + theme_nothing()

```


```{r user-map-wa-kingcounty, warning=F, message=F, echo=F, eval=T, out.width = "100%"}

library(ggplot2)
library(dplyr, warn.conflicts = FALSE)
library(ggsflabel, warn.conflicts = FALSE)
library(tigris, warn.conflicts = FALSE)

wa_state <- states(cb = TRUE, class = "sf") %>% 
  filter(NAME == "Washington")

wa_county <- counties(state = "WA", cb = TRUE, class = "sf")

wa_study_counties <- wa_county 
```


## Map for Washington Sessions in 2020-2021

```{r user-map-wa-allcounties, echo=F, warning=F, message=F, eval=T, out.width = "100%"}

wa_study_counties <- wa_county %>% 
  filter(NAMELSAD %in% c("King County", "Whatcom County", "Chelan County", "Douglas County", "Grant County", "Yakima County", "Lewis County", "Klickitat County", "Benton County", "Franklin County", "Walla Walla County", "Pierce County", "Clark County"))
  
 ggplot() + 
  geom_sf(fill="gray") +
  geom_sf(data = pln_sf_t, color="red", size=1) + 
  geom_sf(data = t, fill=NA, color="black", size=0.5, alpha=0) +
  geom_sf(data = wa_county, fill = NA) +
  geom_sf_label_repel(data = wa_study_counties, aes(label = NAMELSAD), force = 50) +
  coord_sf(datum = st_crs(2285)) +
  labs(fill = "", title="", caption="") + scale_x_continuous(limits = c(0.6e+06, 2.7e+06)) +
    scale_y_continuous(limits = c(-0.7e+06, 0.8e+06)) + theme_nothing()
```
<figcaption align = "center"><b>Figure 2 - App Utilization in Washington </b></figcaption>
Predominant use is concentrated in central Washington, which is part of the Columbia Basin, and has very productive agricultural land.

```{r heat-map-time-series, warning=F, message=F, echo=F} 

#all accesses by date

#https://towardsdatascience.com/time-series-calendar-heatmaps-9f576578fcfe

#calendar day x individual

#https://www.littlemissdata.com/blog/heatmaps

```


```{r summary, eval=F, warning=F, message=F, echo=F}

print(dfSummary(evDownload.01), method = "render")
print(dfSummary(evStart), method = "render")
print(dfSummary(evViewPage.01), method = "render")
print(dfSummary(Outputs.h.s.label.view.counts), method = "render")
print(dfSummary(Outputs.HS.DLS.2021), method = "render")
print(dfSummary(Outputs.PICOL.DLS.2021), method = "render")

```


```{r upload-merged-monthly-csvs, warning=F, message=F, echo=F, results=F}
# merged.csv dataframe 

temp <- list.files(path='CSV', pattern="*.csv", full.names = T)
list2env(lapply(setNames(temp, make.names(gsub("*.csv$", "", temp))), read.csv), envir = .GlobalEnv)
rm(CSV.qAnswers)
merged.csv <- do.call(rbind, lapply(ls(pattern = "CSV"), get))
ignores <- read.csv("ignores.csv")
merged.csv <- filter(merged.csv,!(aid %in% ignores$aid))
```


# App Use by Device

```{r creating-sessions, fig.align='right', warning=F, message=F, echo=F, eval=T}

# Goal: Creating Sessions. 
# 1327 total sessions from 2020-08-26 through 2021-08-31. This doesn't include any sessions initiated by one of the 'ignored' aids.

library("dplyr")
library("lubridate")

#filter merged.csv from aid's first "evStart" to the next "evStart"
merged.csv.dedup <- unique(merged.csv)
device_cat_aid <- unique(evStart[ , c("aid", "device_cat")])

x <- merged.csv.dedup %>% 
  group_by(sessionid = cumsum(evType == 'evStart')) %>% 
  mutate(sessioneventno = row_number())

# WORK SPACE FOR CREATING SESSIONS FOR LANGUAGE
# combine evStart of leftjoin with evViewPage
aid_language <- unique(evViewPage.01[ , c("aid", "evDesc2")])
evStart <- left_join(evStart, aid_language, by="aid") 
evStart_aid_language <- unique(evStart[ , c("aid", "evDesc2.y")])
x <- left_join(x, evStart_aid_language, by="aid")

x$ts <- ymd_hms(x$ts)

```


## Devices Utilized to Access the Application in 2020-2021

```{r analyzing-devices, warning=F, message=F, echo=F, results=F, eval=T}
# SubQuestion #1: Which operating systems are utilized to access the application? 

evStart$device_cat <- gsub(":","",evStart$device_cat)
evStart$device_cat <- recode(evStart$device_cat, "c('Pixel 3a Android 10') = 'android'")

str(evStart)
per_data <- evStart %>%
  count(device_cat) %>% 
  mutate(per = n / sum(n),
         per_label = paste0(round(per*100), "%"))

library(ggplot2)
ggplot(per_data, aes(x = reorder(n, -per), y=per)) + 
  geom_bar(stat = "identity", fill = "darkseagreen1", color = "black") + 
  geom_text(aes(label=per_label), vjust=-0.25) + 
  labs(x = "Devices", y = "Count") + 
  theme_bw() + 
  scale_x_discrete(labels = c("iPhone", "Android", "iPad"))
```
<figcaption align = "center"><b>Figure 3 - Bar Chart of Devices Utilized on the Application </b></figcaption>
The three devices utilized to access the application were an iPhone, Android, or iPad. Approximately 75% of users were accessing the app through an iOS system (e.g. iPhone, iPad) and 25% of users were accessing the app through an Android system.

# App Use by Language
## Frequency of Each Language Accessed on the Application in 2020-2021
```{r analyzing-language-frequency, warning=F, message=F, echo=F, results=F, eval=T, fig.align='center'}
# SubQuestion #2: Which language is more frequently utilized with the 'Pesticide Labels Now' application? 

library("dplyr")
count_Language <- evViewPage.01 %>%
  count(evDesc2)

library(tidyverse)

str(evViewPage.01)
per_data2 <- evViewPage.01 %>%
  count(evDesc2) %>% 
  mutate(per = n / sum(n),
         per_label = paste0(round(per*100), "%"))

ggplot(per_data2, aes(x = reorder(n, -per), y=per)) + 
  geom_bar(stat = "identity", fill = "lightblue", color = "black") + 
  geom_text(aes(label=per_label), vjust=-0.25) + 
  labs(x = "Language", y = "Percent") + 
  theme_bw() + 
  scale_x_discrete(labels = c("English", "Spanish"))
```
<figcaption align = "center"><b>Figure 4 - Bar Chart of Language Frequency on the Application </b></figcaption>
The data shows there is 18% more activity in English than Spanish. "Activity" can be noted as the number of clicks done on the application. Since the ‘Pesticides Labels Now! application initially asks the user which language they wish to proceed in, there is no “default” language and the results can be concluded as reliable and robust.

# Sessions in Each Language (Not Finalized)
```{r language-by-session, warning=F, message=F, echo=F, results=F, eval=T, fig.align='center'}
library("dplyr")
sessionlanguage <- table(evStart_aid_language$evDesc2.y)
kable(sessionlanguage)
```



```{r device_cat_aid, warning=F, message=F, echo=F, results=F, eval=T}

# Retrieving each ID's device and accessed language
library(tidyr)
library(ggplot2)


device_cat_aid <- unique(evStart[ , c("aid", "device_cat")])
device_cat_aid$device_cat <- gsub(":","",device_cat_aid$device_cat)
device_cat_aid$device_cat <- recode(device_cat_aid$device_cat, "c('Pixel 3a Android 10') = 'android'")
aid_device_language <- left_join(evViewPage.01, device_cat_aid, by="aid") 

table(aid_device_language$evDesc2, aid_device_language$device_cat)
```


```{r freq-of-lang-by-device-with-percents, warning=F, message=F, echo=F, results=F, eval=F}
# Frequency of Different Languages by Device w/ Percentage Labels 
# the percentages are not accurately placed

ggplot(aid_device_language, aes(x=evDesc2)) + 
  geom_bar(aes(y = 2*(..count..)/sum(..count..), fill = device_cat, group=device_cat), stat="count") +
  geom_label(aes(label = scales::percent(2*(..count..)/sum(..count..)),
                  group = device_cat), position = "fill", stat= "count", vjust = 0) +
  labs(y = "Percent", fill="device_cat") +
  scale_y_continuous(labels = scales::percent)
  
```


## Frequency of Different Languages by Operating System in 2020-2021
```{r freq-of-lang-by-operating-system, warning=F, message=F, echo=F, results=F, eval=T, fig.cap="iOS users are more likely to access the information in English than Spanish. Android users are more likely to access the information in Spanish than English. This raises the question why Spanish-speaking users are more likely to have an Android device."}
#Without percentage labels 
library(car)
aid_device_language2 <- aid_device_language
aid_device_language2$device_cat <- recode(aid_device_language2$device_cat,"c('iphone') = 'iOS'")
aid_device_language2$device_cat <- recode(aid_device_language2$device_cat,"c('ipad') = 'iOS'")
aid_device_language2$device_cat <- recode(aid_device_language2$device_cat,"c('android') = 'Android'")

aid_device_language2 <- filter(aid_device_language2, !is.na(device_cat))

aid_device_language2 <- filter(aid_device_language2, !is.na(evDesc2))

ggplot(data = aid_device_language2, aes(x = evDesc2, fill = device_cat)) + 
  geom_bar(position = "fill") + 
  scale_y_continuous(labels = function(x) paste0(x*100, "%")) + 
   labs(x = "Language", 
       y = "Percentage") +
      scale_x_discrete(labels = c("English", "Spanish")) +
      scale_fill_discrete(name = "Operating System", labels = c("Android", "iOS"))  
```
<figcaption align = "center"><b>Figure 5 - Bar Chart of Language Frequency by Operating System </b></figcaption>
iOS users are more likely to access the information in English than Spanish. Android users are more likely to access the information in Spanish than English. This raises the question of why Spanish-speaking users are more likely to have an Android device. 

```{r, eval=F, echo=F}
# Subquestion #4: What is the average number of labels looked at per session? 

#Notes from Dennis on ‘How to find Number of Labels Search Per User in a Session’:
# 1. Sort the list by aid 
# 2. Sort by time stamp (not that it matters)
# 3. Iterate through the list from (1) evStart 
# 4. Set up a counter - evViewHS , from one evStart to the next evStart 
```


```{r creating sessions, warning=F, message=F, echo=F, results=F, eval=T}

# Y = unique Sessions including activity, start time, end time, etc. 

library(data.table)
library(dplyr)
library(ggplot2)
library(lubridate)

merged.csv.dedup <- unique(merged.csv)

x <- merged.csv.dedup %>% 
  group_by(sessionid = cumsum(evType == 'evStart')) %>% 
  mutate(sessioneventno = row_number())

x$ts <- ymd_hms(x$ts)
x$ts <- force_tz(x$ts, "UTC")

setDT(x)
y <- x[ , .(session_start = min(ts), session_end = max(ts), num_occurance = .N), by = sessionid]

#'session time' column is added 
y$session_start <- with_tz(y$session_start, tzone = "America/Los_Angeles")
y$session_end <- with_tz(y$session_end, tzone = "America/Los_Angeles")

y$sessiontime <- ymd_hms(y$session_end) - ymd_hms(y$session_start)
y$sessiontime2 <- as.double(y$sessiontime)
y$sessiontimemin <- y$sessiontime2/60

# WORK SPACE FOR ADDING LANGUAGE TO Y 
#sessionid_language <- unique(x[ , c("sessionid", "evDesc2.y")])
#y <- left_join(y, sessionid_language, by="sessionid")

```


# App Use By Time
<figcaption align = "center"><b>Note: For the Calendar HeatMaps, the shade of blue will indicate the usage on the application. A darker shade of blue corresponds to less activity, while a lighter shade of blue corresponds to more activity. If there is no blue, this means there was no application usage during that time (e.g. month, day, hour). </b></figcaption>
## Comparing User Sessions by 'Day of the Month', 'Month', and 'Activity of the User' in 2020-2021
```{r heatmap1, warning=F, message=F, echo=F, results=F, eval=T}
# x=day, y=month, fill="activity"/number of occurances

library(lubridate)
y$hour <- hour(y$session_start)
y$day <- day(y$session_start)
y$week <- week(y$session_start)
y$month <- month(y$session_start)
y$month <- month.abb[as.numeric(y$month)]
# (the line above converts month number to month name)
y$year <- year(y$session_start)
y$month = factor(y$month, levels = month.abb)
y$Month_Yr <- format(as.Date(y$session_start), "%Y-%m")


ggplot(y, aes(x=day, y=Month_Yr)) + geom_tile(aes(fill=num_occurance)) +
  labs(x="Day of the Month",
       y="Month",
       title = "2020-2021 Calendar Heatmap", 
       fill="Activity of the User")
       
```
<figcaption align = "center"><b>Figure 6 - Calendar HeatMap Analyzing Each Session’s Duration in Comparison to the 'Day of the Month', 'Month', and 'Activity of the User' </b></figcaption>
Growing season starts around mid-March till the end of November. This figure depicts the increase in session duration mid-year. The rise in activity at this time conveys the success of the application targeting this specific population of  farmworkers.

## Comparing User Sessions by 'Hour of the Day', 'Day of the Month', and 'Activity of the User' in 2020-2021
```{r heatmap2, warning=F, message=F, echo=F, results=F, eval=T}

# x=hour of the day, y=day of the month, fill="activity"/number of occurances
ggplot(y, aes(x=hour, y=day)) + geom_tile(aes(fill=num_occurance)) +
  labs(x="Hour of The Day",
       y="Day of the Month",
       title = "2020-2021 Calendar Heatmap", 
       fill="Activity of the User")
       
```
<figcaption align = "center"><b>Figure 7 - Calendar HeatMap Analyzing Each Session’s Duration in Comparison to the 'Hour of the Day', 'Day of the Month', and 'Activity of the User' </b></figcaption>
In regards to the 'Day of the Month', the usage remains relatively consistent. However, there is a spike in usage of the application each day from 12-3 PM. 

## Comparing User Sessions by 'Month', 'Day of the Month', and 'Session Time (in minutes)' in 2020-2021
```{r heatmap3, warning=F, message=F, echo=F, results=F, eval=T, fig.width=10}
# heatmap attempt 6 (this is the one included in the poster)
# sessiontime is done in seconds here 

ggplot(y, aes(x=Month_Yr, y=day)) + geom_tile(aes(fill=sessiontimemin)) + 
 labs(x="Month",
       y="Day of the Month",
       title = "2020-2021 Calendar Heatmap", 
       fill="Session Time (minutes)")
```
<figcaption align = "center"><b>Figure 8 - Calendar HeatMap Analyzing Each Session’s Duration in Comparison to the 'Month', 'Day of the Month', and 'Session Time' (in minutes) </b></figcaption>
Growing season starts around mid-March till the end of November. Figure 5 depicts the increase in session duration from April to August. The rise in activity at this time conveys the success of the application targeting this specific population of farmworkers. 

## Comparing User Sessions by 'Hour of the Month', 'Day of the Month', 'Month', and 'Year' in  2020-2021
```{r heatmap4, warning=F, message=F, echo=F, results=F, eval=T}

library(ggplot2)
library(dplyr) #easier data wrangling 
library(viridis) #colour blind friendly palette, works in B&W also
library(lubridate) 
library(ggExtra) #because remembering ggplot theme options is beyond me
library(tidyr) 

df <-y %>% select(sessionid,day,hour,month,year)
p <-ggplot(df,aes(day,hour))+
  geom_tile(color= "white",size=0.1) + 
  scale_fill_viridis(name="Hrly Temps C",option ="C")
p <-p + facet_grid(year~month)
p <-p + scale_y_continuous(trans = "reverse", breaks = unique(df$hour))
p <-p + scale_x_continuous(breaks =c(1,10,20,31))
p <-p + theme_minimal(base_size = 8)
p <-p + labs(title= paste("Session Analytics"), x="Day of the Month", y="Hour Commencing")
p <-p + theme(legend.position = "bottom")+
  theme(plot.title=element_text(size = 14))+
  theme(axis.text.y=element_text(size=6)) +
  theme(strip.background = element_rect(colour="white"))+
  theme(plot.title=element_text(hjust=0))+
  theme(axis.ticks=element_blank())+
  theme(axis.text=element_text(size=7))+
  theme(legend.title=element_text(size=8))+
  theme(legend.text=element_text(size=6))

p

```
<figcaption align = "center"><b>Figure 9 - Calendar HeatMap Analyzing Each Session’s Duration in Comparison to the Hour of the Month, Day of the Month, Month, and Year </b></figcaption>
It is important to note here that each line represents an individual session. Starting from August 2020, the app utilization rises each month as indicated by the increasing amount of lines(sessions). January through April 2021 can be seen as the most successful months for the application due to its popular activity during growing season. 

# App Use By Activity 
## Frequency of Each Source Page Accessed on the Application in 2020-2021
```{r source-page, echo=F, warning=F, message=F, results=F, eval=T, fig.width = 7, fig.height=7}
str(evDownload.01)
download_data <- evDownload.01 %>%
  count(sourcePage) %>% 
  mutate(per = n / sum(n),
         per_label = paste0(round(per*100), "%"))

ggplot(download_data, aes(x = reorder(n, -per), y=per)) + 
  geom_bar(stat = "identity", fill = "lavender", color = "black") + 
  geom_text(aes(label=per_label), vjust=-0.25) + 
  labs(x = "Source Page", y = "Count") + 
  scale_y_continuous(labels(scales::percent)) + 
  theme_bw() + 
  scale_x_discrete(labels = c("PICOL", "H&S", "H&S Supplement"))
```
<figcaption align = "center"><b>Figure 10 - Barchart Displaying Frequency of Source Page Accessed </b></figcaption>
'PICOL' can be notably distinguished as the most popular source page accessed by users. 

## Activity in Each Label Section in 2020-2021
```{r activity-in-label-sections, echo=F, warning=F, message=F, results=F, eval=T, fig.width = 10, fig.height=10}
library(ggplot2)
library(tidyverse)

data <- data.frame(label = factor(c("Product Information", "PPE", "Pesticide Labels", "Health and Safety", "First Aid", "Producer Information", "Physical or Chemical Hazards", "Storage and Disposal", "Engineering Controls", "Environmental Protection", "Spray Drift Prevention" )),
                   count = c(1760, 1180, 914, 472, 464, 436, 356, 286, 278, 274, 262))

ggplot(data, aes(x = reorder(label, -count),y=count)) +
    geom_bar(stat="identity") + 
    scale_x_discrete(limits=(data$label)) + 
    geom_text(aes(label=count), hjust=-0.3) +
    coord_flip() + 
    xlab("Label Section") + 
    ylab("Count (n) ") + 
    ggtitle("¡Etiquetas de pesticidas, ahora!™/Pesticide Labels, Now!™ Views by Label Sections") 
```
<figcaption align = "center"><b>Figure 11 - Barchart Displaying Frequency of Each Link Accessed </b></figcaption>
The frequency of each 'Label Section' item accessed on the 'Pesticides Labels Now' application was analyzed. 'Product Information', 'Personal Protective Equipment' and 'Pesticide Labels' are the most popularly accessed sections by users.

## Frequency of Links Utilized in 2020-2021
```{r freq-of-links, echo=F, warning=F, message=F, eval=T, results=F, fig.width = 17, fig.height=10}
str(evViewPage.01)
per_data3 <- evViewPage.01 %>%
  count(evDesc1) %>% 
  mutate(per = n / sum(n),
         per_label = paste0(round(per*100), "%"))

ggplot(per_data3, aes(x = reorder(n, -per), y=per)) + 
  geom_bar(stat = "identity", fill = "lightblue", color = "black") + 
  geom_text(aes(label=per_label), vjust=-0.25) + 
  labs(x = "Links", y = "Count") + 
  scale_y_continuous(labels(scales::percent)) + 
  theme_bw()  + 
  scale_x_discrete(labels = c("Labels Search", "HS Label", "PICOL Search", "More", "Resources", "PICOL Label", "Feedback", "About", "EULA", "Partners", "Contact", "Disclaimer", "Privacy", "Update News"))
```
<figcaption align = "center"><b>Figure 12 - Barchart Displaying Frequency of Different Links by Language </b></figcaption>
The frequency of each 'Link' accessed on the 'Pesticides Labels Now' application was analyzed. 'Labels Search' was the most popularly viewed section by all users.

## Frequency of Different Links by Language in 2020-2021
```{r freq-diff-links-by-language, echo=F, warning=F, message=F, eval=T, results=F, fig.width = 17, fig.height=10}
library(dplyr)
library(ggplot2)

tab <-  evViewPage.01 %>% group_by(evDesc1,evDesc2,.drop=FALSE) %>% tally()
tab <- tab %>% mutate(perc=n/sum(n)) %>% 
ggplot() + geom_col(aes(x=evDesc1,y=perc,fill=evDesc2),position="dodge") + 
scale_y_continuous(labels =scales::percent) +
labs(x = "Links", 
       y = "Percentage") + 
  theme_classic() +
  scale_fill_brewer(palette = "Pastel1") 
tab
```
<figcaption align = "center"><b>Figure 13 - Barchart Displaying Frequency of Different Links by Language </b></figcaption>
The frequency of each ‘Label Section’ item accessed on the ‘Pesticides Labels Now’ application was compared to the user's accessed language. 'EULA' was most popularly used by English readers and 'Update News' was most popularly used by Spanish readers.

## Table of Top Ten Searched Pesticides in 2020-2021 
```{r searchedpesticides, fig.align='center', fig.cap="Amongst 129 total pesticides in the application, Table 1 displays the top ten searched pesticides. 'Lorsban® Advanced' was the most popularly looked at pesticide among users from August 2020-2021.", warning=F, message=F, echo=F, results=T, eval=T}

library("dplyr")
table <- table(evDownload.01$prodName)
my_table <- table[order(table, decreasing = TRUE)]
my_table <- my_table[1:10] 
kable(my_table)
```
<figcaption align = "center"><b>Table 1 - Top Ten Searched Pesticides </b></figcaption>
Amongst 129 total pesticides in the application, Table 1 displays the top ten searched pesticides. 'Lorsban® Advanced' was the most popularly looked at pesticide among users from August 2020-2021.

# Average Session Duration 
## 90.11 minutes
```{r session-duration, warning=F, message=F, echo=F, results=F, eval=F}
# Average session duration 
# sum(y$sessiontime)
# (7179658/60)
# 119661/1328
#90.11
```


# [Appendix](https://github.com/aartitandon/SURE-EH-Research-Project/blob/main/Appendix.md)


